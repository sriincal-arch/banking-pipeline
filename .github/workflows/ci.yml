name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: |
          pip install sqlfluff ruff black
          
      - name: Lint Python
        run: |
          ruff check dagster/
          black --check dagster/
          
      - name: Lint SQL
        run: |
          sqlfluff lint dbt/models/ --dialect duckdb || true

  test:
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: |
          pip install -e ".[dev]"
          
      - name: Install dbt packages
        run: |
          cd dbt && dbt deps
          
      - name: Run dbt build (compile + test)
        run: |
          cd dbt && dbt build --target test
        env:
          DUCKDB_DATABASE: ":memory:"
          
  build:
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          tags: banking-pipeline:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  integration:
    runs-on: ubuntu-latest
    needs: build
    services:
      minio:
        image: minio/minio:latest
        ports:
          - 9000:9000
        env:
          MINIO_ROOT_USER: minioadmin
          MINIO_ROOT_PASSWORD: minioadmin
        options: >-
          --health-cmd "curl -f http://localhost:9000/minio/health/live"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 3
          
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: pip install -e ".[dev]"
        
      - name: Setup MinIO buckets
        run: |
          pip install minio
          python -c "
          from minio import Minio
          client = Minio('localhost:9000', 'minioadmin', 'minioadmin', secure=False)
          for bucket in ['landing', 'raw', 'access']:
              if not client.bucket_exists(bucket):
                  client.make_bucket(bucket)
          "
          
      - name: Generate and upload sample data
        run: |
          python scripts/generate_sample_data.py --seed 42
          pip install boto3
          python -c "
          import boto3
          s3 = boto3.client('s3', endpoint_url='http://localhost:9000',
                           aws_access_key_id='minioadmin',
                           aws_secret_access_key='minioadmin')
          s3.upload_file('data/sample/accounts.csv', 'landing', 'accounts.csv')
          s3.upload_file('data/sample/customers.csv', 'landing', 'customers.csv')
          "
          
      - name: Run integration tests
        run: |
          pytest tests/integration/ -v
        env:
          MINIO_ENDPOINT: http://localhost:9000
          MINIO_ACCESS_KEY: minioadmin
          MINIO_SECRET_KEY: minioadmin
          DUCKDB_DATABASE: ./test_banking.duckdb


